# Ensure Homebrew's bash is available for plugins (requires bash 4+)
set-environment -g PATH "/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin"

# Set terminal title to session name (WezTerm uses this for tab naming)
set -g set-titles on
set -g set-titles-string "#{session_name}"

# True color (24-bit RGB) support for WezTerm
# Using xterm-256color as base (tmux-256color caused crashes with multiple nvim instances)
set -g default-terminal "xterm-256color"
set -ag terminal-overrides ",xterm-256color:Tc"

# use C-Space as prefix
unbind-key C-b
set -g prefix C-Space
bind-key C-Space send-prefix

unbind r
bind r source-file ~/.tmux.conf

# Enable mouse support (post v1.9 specific)
set -g mouse on

# Start window numbering at '1' instead of '0' (for convenience)
set -g base-index 1
set -g pane-base-index 1

## pane border - updated for better visibility with Tokyo Night
set-option -g pane-border-style fg=brightblack
set-option -g pane-active-border-style fg=cyan

# try and ensure tmux has ssh access
set -g update-environment "DISPLAY SSH_ASKPASS SSH_AGENT_PID SSH_CONNECTION WINDOWID XAUTHORITY"
set-environment -g 'SSH_AUTH_SOCK' ~/.ssh/ssh_auth_sock

# Custom mint green color scheme to complement Dracula in WezTerm
# (Commented out to allow tmux-powerkit to manage the status bar)
# # Status bar with light mint background
# set -g status-style bg='#f4dbd8',fg='#282a36'
#
# # Remove the left side of the status bar
# set -g status-left ''
# set -g status-left-length 0
#
# # Right status with time and prefix indicator - styled prettier
# set -g status-right '#[fg=#282a36,bg=#f4dbd8] #{?client_prefix,ðŸš€ ,}#[fg=#f8f8f2,bg=#d89891,bold] %I:%M %p '
# set -g status-right-length 50
#
# # Window/tab status with prettier styling and powerline pointed edges
# # Each tab ends with a right-pointing triangle
# setw -g window-status-format "#[bg=#f4dbd8,fg=#6272a4]#[bg=#f4dbd8,fg=#282a36] #I  #W #[bg=#f4dbd8,fg=#f4dbd8]"
# setw -g window-status-separator ""
#
# # Active tab - Dracula green with right-pointing triangle at the end
# setw -g window-status-current-format "#[bg=#f4dbd8,fg=#d89891]#[bg=#d89891,fg=#282a36,bold] #I  #W #[bg=#f4dbd8,fg=#d89891]"

# Use vim keybindings in copy mode
setw -g mode-keys vi

# Copy mode selection style - neutral grey with readable text
set -g mode-style 'bg=#585b70,fg=#cdd6f4'

# Copy mode search match styles - ensure search text is visible
set -g copy-mode-match-style 'bg=#f9e2af,fg=#1e1e2e'
set -g copy-mode-current-match-style 'bg=#a6e3a1,fg=#1e1e2e,bold'

# Message/command prompt style (including search prompt)
set -g message-style 'bg=#313244,fg=#cdd6f4'
bind-key h select-window -p
bind-key l select-window -n

# Use v to trigger selection    
bind-key -T copy-mode-vi v send-keys -X begin-selection

# Use y to yank current selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Powerkit settings
set -g @plugin 'fabioluciano/tmux-powerkit'
## Choose theme and variant
set -g @powerkit_theme 'tokyo-night'
set -g @powerkit_theme_variant 'night'
## Enable plugins
set -g @powerkit_plugins 'datetime,battery,cpu,memory'
## Use US date format (mm/dd instead of dd/mm)
set -g @powerkit_plugin_datetime_format 'datetime-us'
## Auto-detect OS icon
set -g @powerkit_session_icon 'auto'
## Remap options_viewer to avoid conflict with tmux's default ? (list-keys)
set -g @powerkit_core_options_viewer_key 'O'

# Resurrect settings
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-processes '"rails console" "rails server" "psql *" "pgcli *" "nvim" "cursor-agent"'

# Continuum settings - auto-save only (no restore, we use bootstrap script)
set -g @continuum-restore 'off'
set -g @continuum-save-interval '0'

set -g status-position bottom

# Initialize TPM (Tmux Plugin Manager)
# Note: Requires /usr/local/bin/bash -> /opt/homebrew/bin/bash symlink
# so that #!/usr/bin/env bash finds bash 4+ (needed by tmux-powerkit)
run '~/.tmux/plugins/tpm/tpm'
